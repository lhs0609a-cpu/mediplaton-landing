<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>파트너 가입 | 메디플라톤</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
    <style>
        :root {
            --primary: #1428A0;
            --primary-light: #E8EDFF;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-900: #111827;
            --white: #ffffff;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Pretendard Variable', -apple-system, sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .register-box {
            background: var(--white);
            padding: 40px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 520px;
        }

        .register-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .register-logo h1 {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .register-logo p {
            color: var(--gray-500);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--gray-700);
        }

        .form-group label .required {
            color: var(--danger);
            margin-left: 2px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 70px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            width: 100%;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: #0f1f7a;
        }

        .btn-primary:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        .error-msg {
            background: #FEE2E2;
            color: var(--danger);
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        .success-screen {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }

        .success-screen .icon {
            width: 80px;
            height: 80px;
            background: #D1FAE5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 36px;
        }

        .success-screen h2 {
            font-size: 22px;
            color: var(--gray-900);
            margin-bottom: 12px;
        }

        .success-screen p {
            color: var(--gray-500);
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .success-screen a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .success-screen a:hover {
            text-decoration: underline;
        }

        .login-link {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: var(--gray-500);
        }

        .login-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .login-link a:hover {
            text-decoration: underline;
        }

        .pw-hint {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 4px;
        }

        @media (max-width: 640px) {
            body { padding: 12px; }
            .register-box { padding: 24px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="register-box">
        <!-- Registration Form -->
        <div id="registerForm">
            <div class="register-logo">
                <h1>메디플라톤 파트너 가입</h1>
                <p>파트너 계정을 생성하면 관리자 승인 후 이용할 수 있습니다.</p>
            </div>

            <div class="error-msg" id="errorMsg"></div>

            <form id="partnerRegForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>이름 <span class="required">*</span></label>
                        <input type="text" id="regName" placeholder="홍길동" required>
                    </div>
                    <div class="form-group">
                        <label>연락처 <span class="required">*</span></label>
                        <input type="tel" id="regPhone" placeholder="010-0000-0000" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>이메일 <span class="required">*</span></label>
                    <input type="email" id="regEmail" placeholder="email@example.com" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>비밀번호 <span class="required">*</span></label>
                        <input type="password" id="regPassword" placeholder="8자 이상" minlength="8" required>
                        <div class="pw-hint">영문, 숫자 포함 8자 이상</div>
                    </div>
                    <div class="form-group">
                        <label>비밀번호 확인 <span class="required">*</span></label>
                        <input type="password" id="regPasswordConfirm" placeholder="비밀번호 재입력" minlength="8" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>병원/약국명</label>
                    <input type="text" id="regHospital" placeholder="예: 메디플라톤 의원">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>업종</label>
                        <select id="regBusiness">
                            <option value="">선택</option>
                            <option value="hospital">병원/의원</option>
                            <option value="dental">치과</option>
                            <option value="oriental">한의원</option>
                            <option value="pharmacy">약국</option>
                            <option value="plastic">성형외과</option>
                            <option value="derma">피부과</option>
                            <option value="eye">안과</option>
                            <option value="ortho">정형외과</option>
                            <option value="other">기타 의료</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>지역</label>
                        <select id="regRegion">
                            <option value="">선택</option>
                            <option value="seoul">서울</option>
                            <option value="gyeonggi">경기</option>
                            <option value="incheon">인천</option>
                            <option value="busan">부산</option>
                            <option value="daegu">대구</option>
                            <option value="daejeon">대전</option>
                            <option value="gwangju">광주</option>
                            <option value="ulsan">울산</option>
                            <option value="sejong">세종</option>
                            <option value="gangwon">강원</option>
                            <option value="chungbuk">충북</option>
                            <option value="chungnam">충남</option>
                            <option value="jeonbuk">전북</option>
                            <option value="jeonnam">전남</option>
                            <option value="gyeongbuk">경북</option>
                            <option value="gyeongnam">경남</option>
                            <option value="jeju">제주</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>메모</label>
                    <textarea id="regMessage" placeholder="추가 전달사항이 있으면 입력하세요"></textarea>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">가입 신청</button>
            </form>

            <div class="login-link">
                이미 계정이 있으신가요? <a href="partner-dashboard.html">로그인</a>
            </div>
        </div>

        <!-- Success Screen -->
        <div class="success-screen" id="successScreen">
            <div class="icon">&#10003;</div>
            <h2>가입 신청이 완료되었습니다</h2>
            <p>
                관리자가 신청 내용을 확인한 후 승인해드립니다.<br>
                승인이 완료되면 등록하신 이메일로 알림이 발송됩니다.<br>
                승인 후 파트너 대시보드를 이용하실 수 있습니다.
            </p>
            <a href="partner-dashboard.html">파트너 대시보드로 이동 &rarr;</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        const supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

        document.getElementById('partnerRegForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const errorMsg = document.getElementById('errorMsg');
            const submitBtn = document.getElementById('submitBtn');
            errorMsg.style.display = 'none';

            const name = document.getElementById('regName').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const hospital_name = document.getElementById('regHospital').value.trim() || null;
            const business = document.getElementById('regBusiness').value || null;
            const region = document.getElementById('regRegion').value || null;
            const message = document.getElementById('regMessage').value.trim() || null;

            // Validation
            if (password !== passwordConfirm) {
                errorMsg.textContent = '비밀번호가 일치하지 않습니다.';
                errorMsg.style.display = 'block';
                return;
            }

            if (password.length < 8) {
                errorMsg.textContent = '비밀번호는 8자 이상이어야 합니다.';
                errorMsg.style.display = 'block';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '처리 중...';

            try {
                // 1. Supabase Auth signUp
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email,
                    password
                });

                if (authError) {
                    if (authError.message.includes('already registered')) {
                        throw new Error('이미 등록된 이메일입니다.');
                    }
                    throw authError;
                }

                const userId = authData.user?.id;
                if (!userId) {
                    throw new Error('계정 생성에 실패했습니다. 다시 시도해주세요.');
                }

                // 2. partners 테이블에 INSERT
                const { error: insertError } = await supabase
                    .from('partners')
                    .insert([{
                        name,
                        phone,
                        email,
                        hospital_name,
                        business,
                        region,
                        message,
                        status: 'pending',
                        user_id: userId,
                        commission_rate: 0.015
                    }]);

                if (insertError) throw insertError;

                // 3. 즉시 로그아웃 (승인 전이므로)
                await supabase.auth.signOut();

                // 4. 성공 화면
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('successScreen').style.display = 'block';

            } catch (error) {
                errorMsg.textContent = error.message || '가입 처리 중 오류가 발생했습니다.';
                errorMsg.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = '가입 신청';
            }
        });
    </script>
</body>
</html>
